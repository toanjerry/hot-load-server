class HotClient{constructor(e){this.server=e}setOpts(e={}){return this.opts={...this.opts,...e},this}connect(){try{this.ws=new WebSocket(this.server),this.setupEvent()}catch(e){console.error(`HOT: Failed to connect ${this.server}`,e),this.opts.reconnectInterval&&setTimeout(()=>this.connect(),this.opts.reconnectInterval)}}setupEvent(){this.ws.addEventListener("open",()=>{this.ws.send(JSON.stringify({type:"register",app:HMR.location.app,origin:HMR.location.origin,domain:HMR.location.domain})),console.log("HOT: connected")}),this.ws.addEventListener("close",()=>{this.opts.reconnectInterval&&setTimeout(()=>this.connect(),this.opts.reconnectInterval),console.log("HOT: disconnected")}),this.ws.addEventListener("message",e=>{const t=JSON.parse(e.data);if("change"===t.type){HMR.overlay();try{HotEngine.update(t),HMR.engine&&HMR.engine.process(t)}catch(e){console.error("HOT: Fail to process message",e),HMR.overlay(e,t)}}else"config"===t.type?HMR.setOpts(t.opts).init():console.info(t)})}}const HotEngine=new function(){this.update=e=>{if("refresh"===e.action)return window.location.reload();"refresh-js"===e.action?function(e){if(!e)return;e=e.split(/[\\/]/).join("/");const t=Array.from(document.getElementsByTagName("script")).find(t=>{if(!t.src)return!1;const n=new URL(t.src);return e.endsWith(n.pathname)});if(t){const e=document.createElement("script");e.src=t.src,e.async=t.async,e.defer=t.defer,t.parentNode.insertBefore(e,t.nextSibling),t.parentNode.removeChild(t)}}(e.path):"refresh-css"===e.action&&function(e){if(!e)return;e=e.split(/[\\/]/).join("/");const t=Array.from(document.getElementsByTagName("link")).find(t=>{if("stylesheet"!==t.rel||!t.href)return!1;const n=new URL(t.href);return e.endsWith(n.pathname)});if(t){const e=t.cloneNode();e.href=t.href.split("?")[0]+"?t="+Date.now(),t.parentNode.insertBefore(e,t.nextSibling),t.parentNode.removeChild(t)}}(e.path)}},HMR=new function(){this.connect=async function(e,t){this.detectLocation(),this.server=`${this.location.protocol}//${e}:${t}`,this.initClient()},this.setOpts=function(e){return this.opts=e||{},this},this.initClient=async function(){this.client||(this.client=new HotClient(this.server),this.client.setOpts({reconnectInterval:3e3}).connect())},this.init=()=>{this.initEngine(),this.opts.overlay&&this.initOverlay()},this.initEngine=async function(e=!1){if(!this.engine||e){if(this.opts?.engine||(this.opts.engine="default"),!window.ClientEngine){const e=await import(`${this.server}/engine/${this.opts.engine}.js`);e||console.error("HOT: error load engine"),window.ClientEngine=e.default}this.engine=new ClientEngine,this.client.setOpts(this.engine.opts),console.log(`HOT: ${this.engine.constructor.name||""} is inited`)}},this.detectLocation=()=>{this.location={app:window?.Client?.base?.app||"hot",domain:window?.Client?.domain||window.location.host,protocol:window.location.protocol,host:window.location.host,port:window.location.port,origin:window.location.origin}},this.overlay=function(e="",t){if(!this.opts.overlay)return;const n=document.getElementById("hmr-overlay");e?(delete t.js,delete t.css,document.getElementById("hmr-overlay-content").innerText=e+"\n"+JSON.stringify(t),n.style.display="flex"):n.style.display="none"},this.initOverlay=()=>{let e=document.getElementById("hmr-overlay");if(e)return;e=document.createElement("div"),e.id="hmr-overlay",e.style.position="fixed",e.style.top=0,e.style.left=0,e.style.width="100vw",e.style.height="100vh",e.style.background="rgba(0,0,0,0.7)",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex=99999,e.style.display="none";const t=document.createElement("div");t.id="hmr-overlay-content",t.style.background="#fff",t.style.padding="2rem",t.style.boxShadow="0 2px 16px rgba(0,0,0,0.2)",t.style.color="red",e.appendChild(t),document.body.appendChild(e)}};HMR.connect("localhost",3e3);